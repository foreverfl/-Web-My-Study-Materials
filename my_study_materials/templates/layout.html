{% load static %}
{% load socialaccount %} <!-- socialaccount 태그 라이브러리 로드 -->

<!DOCTYPE html>
<html>
  <title>My Study Materials</title>
  <meta name="description" content="나만의 공부자료를 정리하고 공유하는 사이트">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  <meta property="og:title" content="My Study Materials">
  <meta property="og:description" content="나만의 공부자료를 정리하고 공유하는 사이트">
  <meta property="og:image" content="{% static 'images/noun-study.png' %}">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="{{ request.build_absolute_uri }}">
  <meta property="twitter:title" content="My Study Materials">
  <meta property="twitter:description" content="나만의 공부자료를 정리하고 공유하는 사이트">
  <meta property="twitter:image" content="{% static 'images/noun-study.png' %}">

  <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
  <link rel="stylesheet" href="{% static 'bootstrap-5.3.1-dist/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css'%}">
  <link rel="stylesheet" type="text/css" href="{% static 'css/pygments.css' %}">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4751026650729929"
    crossorigin="anonymous"></script>
  <body>
    <nav class="navbar navbar-expand-lg pt-4">
      <div class="container-fluid">
        <!-- Logo -->
        <a class="navbar-brand ps-5" href="/">My Study<br>Materials</a>

        <!-- Search Bar -->
        <form class="row g-3" action="{% url 'search' %}" method="get">
          <div class="col-auto">
            <input
              class="form-control mr-sm-2"
              type="text"
              name="q"
              value="{{ request.GET.q }}"
              placeholder="Search"
              aria-label="Search"
            />
          </div>
          <div class="col-auto">
            <button class="btn btn-outline-primary my-2 my-sm-0" type="submit">
              <img
                src="{% static 'bootstrap-icons-1.10.5/search.svg'%}"
                alt="search"
                width="15"
                height="15"
              />
            </button>
          </div>
        </form>

        <!-- Profile -->
        <div class="navbar-nav ml-auto pe-3">
          <div class="nav-item dropdown position-relative">
            <a class="nav-link" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <img src="{% static 'bootstrap-icons-1.10.5/person-circle.svg'%}" alt="person" width="30" height="30" />
            </a>
            <div class="dropdown-menu dropdown-menu-end position-absolute" style="top: 100%; right: 0;" aria-labelledby="navbarDropdown">
              {% if user.is_authenticated %}
                <p class="dropdown-item text-center disabled">{{ user.last_name }} {{ user.first_name }}님 환영합니다!</p>
                
                {% if user.is_staff %}
                  <p class="dropdown-item text-center disabled">관리자</p>
                {% elif subscription.is_subscribed %}
                  <p class="dropdown-item text-center disabled">유료회원</p>
                {% else %}
                  <p class="dropdown-item text-center disabled">무료회원</p>
                {% endif %}

                {% if not subscription.is_subscribed %}
                  <a class="dropdown-item text-center" href="{% url 'payment_describe' %}">구독하기</a>
                  <hr>
                {% endif %}
                
                <a class="dropdown-item text-center" href="{% url 'account_logout' %}">로그아웃</a>
              {% else %}
                <a class="dropdown-item text-center" href="{% url 'account_login' %}">로그인</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container-fluid">
      <div class="row">
        <!-- Left sidebar -->
        <div class="col-xl-2 col-md-2 sidebar py-5">
          <div class="sidebar-sticky">
            <ul class="nav flex-column gap-3">
              <!-- CRUD -->
              {% if user.is_authenticated %}
              <p id="category-settings" class="fw-bold d-flex justify-content-center" data-bs-toggle="collapse" data-bs-target="#categoryButtons">My Categories Settings
                <img id="category-caret-icon" class="align-self-center ms-2" src="{% static 'bootstrap-icons-1.10.5/caret-down-fill.svg'%}" alt="caret-down-fill" width="10" height="10" />                   
              </p>
              <div class="collapse" id="categoryButtons">
                <li class="nav-item rounded d-flex flex-xl-row flex-md-column justify-content-center gap-3">            
                  <a class="btn btn-sm btn-outline-primary" href="#" data-bs-toggle="modal" data-bs-target="#categoryCreateModal">추가</a>
                  <a class="btn btn-sm btn-outline-secondary" href="#" id="updateCategoryBtn" data-bs-target="#categoryUpdateModal">수정</a>
                  <a class="btn btn-sm btn-outline-danger" href="#" id="deleteCategoryBtn">삭제</a>
                </li>
              </div>
              <hr>
              {% endif %}

              <!--User Category -->
              <p class="fw-bold d-flex justify-content-center">My Categories</p>
              {% for category in current_user_categories %}
              <li class="sidebar-category nav-item rounded d-flex justify-content-center">
                  <a class="nav-link" href="{% url 'category_detail' category.id %}">{{ category.name }}</a>
                  <button class="btn btn-sm btn-danger delete-category-button" data-category-id="{{ category.id }}" style="display: none;">삭제</button>
                  <button class="btn btn-sm btn-secondary update-category-button" data-category-id="{{ category.id }}" style="display: none;">수정</button>
              </li>
              {% endfor %}

              <hr>

              <!-- Added Categories (default: Admin Category)-->
              <p class="fw-bold d-flex justify-content-center">Added Categories</p>
              {% for category in admin_categories %}
              <li class="sidebar-category nav-item rounded d-flex justify-content-center">
                  <a class="nav-link" href="{% url 'category_detail' category.id %}">{{ category.name }}</a>
              </li>
              {% endfor %}

              <hr>

              <!-- Others -->
              <li class="sidebar-category nav-item rounded d-flex justify-content-center">
                  <!-- All Categories -->
                  <a class="nav-link fw-bold text-decoration-none text-dark" href="{% url 'category_list' %}">All Categories</a>
              </li>
              
            </ul>
          </div>
        </div>

        <!-- Content will be inserted here -->
        <div class="col-xl-8 col-md-10">
            {% block content %}{% endblock %}
        </div>

        <!-- Right sidebar (Desktop version) -->
        <!-- d-xl-flex: xl 화면 크기에서만 flexbox 컨테이너로 만듦-->
        <div class="col-xl-2 d-xl-flex justify-content-center align-items-center position-fixed" style="height:80vh; right: 0; width: 100%">
          <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4751026650729929"
              crossorigin="anonymous"></script>
          <!-- vertical -->
          <ins class="adsbygoogle"
              style="display:block"
              data-ad-client="ca-pub-4751026650729929"
              data-ad-slot="4768114162"
              data-ad-format="auto"
              data-full-width-responsive="true"></ins>
          <script>
              (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
        </div>

      </div>
    </div>

  <!-- Modal -->
  <!-- Create Category-->
  <div class="modal fade" id="categoryCreateModal" tabindex="-1" role="dialog" aria-labelledby="categoryCreateModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategory">카테고리 추가</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="categoryForm">
            <!-- 공개/비공개 드롭다운 -->
            <div class="form-group d-flex justify-content-end mb-3">
              <select id="category_is_public" name="is_public" class="form-control w-auto">
                <option value="true" style="text-align: center;">공개</option>
                <option value="false" style="text-align: center;">비공개</option>
              </select>
            </div>
            <!-- 제목 -->
            <div class="form-group mb-3">
              <input type="text" class="form-control" id="category-name" name="name" placeholder="카테고리명">
            </div>
            <!-- 설명 텍스트 필드 -->
            <div class="form-group mb-3">
              <textarea class="form-control" id="category-description" name="description" placeholder="설명" rows="10"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-primary" id="saveCategoryBtn">추가하기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- footer -->
  <footer class="bg-light text-muted text-center">
    <div class="container-fluid px-5 py-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center">
        <p class="mb-0" style="font-size: 12px;">
          대표이사: JEON MYEONG KYU | 상호: My Dictionary | 사업자등록번호: 619-09-28407 | 이메일: forever_fl@naver.com 
        </p>
        <p class="mb-0" style="font-size: 12px;">Copyright © 2023 All rights reserved.</p>
      </div>
    </div>
  </footer>
  </body>

  <!-- Bootstrap JS and jQuery -->
  <script src="{% static 'bootstrap-5.3.1-dist/js/bootstrap.bundle.min.js' %}"></script>
  <script>
    // 카테고리 공개/비공개
    // |yesno: Boolean 값을 다른 문자열 값으로 변환
    const isSubscribed = {{ request.user.subscription.is_subscribed|yesno:"true,false" }};
    const categoryIsPublic = document.getElementById('category_is_public');
    if (!isSubscribed) {
      categoryIsPublic.disabled = true;  // 비활성화
    }

    // 카테고리 추가
    document.addEventListener('DOMContentLoaded', function(){
      
      document.querySelector("#saveCategoryBtn").addEventListener('click', function(){
        var formElement = document.querySelector("#categoryForm");
        var formData = new FormData(formElement);
        
        for (var pair of formData.entries()) {
          console.log(pair[0] + ', ' + pair[1]); 
        }
    
        fetch("{% url 'category_create' %}", { // Django에서 지정한 URL을 가져옴
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}', // Django의 CSRF 보호를 우회
          },
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(json => {
              if (json.errors === "Maximum number of categories reached") {
                alert("최대 카테고리 개수를 초과했습니다.");
              } else if (json.errors === "Category name already exists") {
                alert("이미 존재하는 카테고리 이름입니다.");
              } else {
                alert(json.errors || "카테고리를 추가하는 도중 오류가 발생했습니다. 다시 시도해 주세요.");
              }
              throw new Error(`HTTP error! status: ${response.status}`);
            });
          } 
          return response.json();
        })
        .then(json => {
          location.reload();
        })
        .catch((error) => {
          console.log('Error:', error);
        });
      });
    });

    // 카테고리 수정 및 삭제
    document.addEventListener('DOMContentLoaded', function() {
      var editCategoryBtn = document.querySelector('#updateCategoryBtn');
      var deleteCategoryBtn = document.querySelector('#deleteCategoryBtn');

      var updateButtonsVisible = false;
      var deleteButtonsVisible = false;

      // 수정 버튼
      if(editCategoryBtn) {
        editCategoryBtn.addEventListener('click', function() {
          updateButtonsVisible = !updateButtonsVisible;

          if (deleteButtonsVisible) {
            deleteButtonsVisible = false;
            deleteCategoryBtn.textContent = '삭제';
            toggleButtons('.delete-category-button', 'none');
          }

          editCategoryBtn.textContent = updateButtonsVisible ? '취소' : '수정';
          toggleButtons('.update-category-button', updateButtonsVisible ? 'block' : 'none');
        });
      }

      // 삭제 버튼
      if(deleteCategoryBtn) {
        deleteCategoryBtn.addEventListener('click', function() {
          deleteButtonsVisible = !deleteButtonsVisible;

          if (updateButtonsVisible) {
            updateButtonsVisible = false;
            editCategoryBtn.textContent = '수정';
            toggleButtons('.update-category-button', 'none');
          }

          deleteCategoryBtn.textContent = deleteButtonsVisible ? '취소' : '삭제';
          toggleButtons('.delete-category-button', deleteButtonsVisible ? 'block' : 'none');
        });
      }

      function toggleButtons(selector, displayStyle) {
        document.querySelectorAll(selector).forEach(function(button) {
          button.style.display = displayStyle;
        });
      }

      // 카테고리 삭제
      document.querySelectorAll('.delete-category-button').forEach(function(button) {
        button.addEventListener('click', function() {
          var categoryId = this.getAttribute('data-category-id');
          fetch('/category/' + categoryId + '/delete/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': '{{ csrf_token }}'
            },
          }).then(function() {
            location.reload();
          });
        });
      });

      // 카테고리 수정
      document.querySelectorAll('.update-category-button').forEach(function(button) {
        button.addEventListener('click', function() {
          var categoryId = this.getAttribute('data-category-id');
          console.log("선택한 카테고리 ID:", categoryId);
        });
      });
    });

    // Category 모양 변경
    document.addEventListener('DOMContentLoaded', function() {
      const categoryButtons = document.getElementById('categoryButtons'); 
      const categoryCaretIcon = document.getElementById('category-caret-icon');

      categoryButtons.addEventListener('show.bs.collapse', function() {
        categoryCaretIcon.src = "{% static 'bootstrap-icons-1.10.5/caret-up-fill.svg' %}";
      });

      categoryButtons.addEventListener('hide.bs.collapse', function() { 
        categoryCaretIcon.src = "{% static 'bootstrap-icons-1.10.5/caret-down-fill.svg' %}";
      });
    });
    </script>
</html>
